name: CI & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'pnpm' }
      - uses: pnpm/action-setup@v4
        with: { version: 9, run_install: true }
      - run: pnpm lint || true
      - run: pnpm test --if-present
      - run: pnpm build
        env:
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          ELASTIC_NODE: ${{ secrets.ELASTIC_NODE }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
          USER_INDEX: ${{ secrets.USER_INDEX }}
          LOGS_INDEX: ${{ secrets.LOGS_INDEX }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm i -g vercel@latest
      - run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          ELASTIC_NODE: ${{ secrets.ELASTIC_NODE }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
          USER_INDEX: ${{ secrets.USER_INDEX }}
          LOGS_INDEX: ${{ secrets.LOGS_INDEX }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
      - run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} --org ${{ secrets.VERCEL_ORG_ID }} --project ${{ secrets.VERCEL_PROJECT_ID }}
